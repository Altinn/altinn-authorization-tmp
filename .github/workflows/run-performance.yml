name: Run k6 performance test

on:
    workflow_dispatch:
        inputs:
            apiVersion:
                description: 'API Version'
                required: true
                default: 'v1'
            environment:
                description: 'Environment'
                required: true
                default: 'yt01'
                type: choice
                options:
                - yt01
                - staging
                - test
            tag:
                description: 'tag the performance test'
                required: true
                default: 'Performance test'
                type: string
            vus:
                description: 'Number of VUS'
                required: true
                default: 1
                type: number
            duration:
                description: 'Duration of test, ie 30s, 1m, 10m'
                required: true
                default: 1m
                type: string
            parallelism:
                description: 'Number of parallel test runs'
                required: true
                default: 1
                type: number
            breakpoint:
                description: 'Gradually raise the load to number of VUs over the duration of the test. If VUs is high, it will run until the system breaks'
                required: true
                default: false
                type: boolean 
            abortOnFail:
                description: 'Abort on fail. Only used for breakpoint tests'
                required: true
                default: false
                type: boolean 
            testSuitePath:
                description: 'Path to test suite to run'
                required: true
                default: 'src/apps/Altinn.Authorization/test/K6/performance/pdpAuthorizeClientDelegations.js'
                type: choice
                options:
                - 'src/apps/Altinn.Authorization/test/K6/performance/pdpAuthorize/pdpAuthorizeClientDelegations.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/pdpAuthorize/pdpAuthorizeRoleDagl.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/pdpAuthorize/pdpAuthorizeRoleDaglDeny.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/pdpAuthorize/pdpAuthorizeRolePriv.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/clientDelegations/getClientDelegations.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/authorizedParties/getAuthorizedPartiesForSystemUsers.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/authorizedParties/getAuthorizedPartiesForUser.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/authorizedParties/getAuthorizedPartiesForUserPartyId.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/authorizedParties/getAuthorizedPartiesForOrganization.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/rightHolders/getRightHolders.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/consent/postConsent.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/connections/getConnections.js'
                - 'src/apps/Altinn.Authorization/test/K6/performance/connections/getConnectionsAccessPackages.js'
    workflow_call:
      inputs:
            apiVersion:
                description: 'API Version'
                required: true
                type: string
                default: 'v1'
            environment:
                description: 'Environment'
                required: true
                default: 'yt01'
                type: string
            tag:
                description: 'tag the performance test'
                required: true
                default: 'Performance test'
                type: string
            vus:
                description: 'Number of VUS'
                required: true
                default: 1
                type: number
            duration:
                description: 'Duration of test, ie 30s, 1m, 10m'
                required: true
                default: 1m
                type: string
            parallelism:
                description: 'Number of parallel test runs'
                required: true
                default: 1
                type: number
            breakpoint:
                description: 'Gradually raise the load to number of VUs over the duration of the test. If VUs is high, it will run until the system breaks'
                required: true
                default: false
                type: boolean 
            abortOnFail:
                description: 'Abort on fail. Only used for breakpoint tests'
                required: true
                default: false
                type: boolean 
            testSuitePath:
                description: 'Path to test suite to run'
                required: true
                default: 'src/apps/Altinn.Authorization/test/K6/performance/pdpAuthorizeClientDelegations.js'
                type: string

permissions:
  id-token: write
  contents: read
run-name: ${{ inputs.tag }} ${{ inputs.vus }}/${{ inputs.duration }}/${{ inputs.parallelism }}
jobs:
  k6-performance:
    runs-on: ubuntu-latest
    environment: test
    steps:
    - name: Checkout code
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
    - name: OIDC Login to Azure Public Cloud
      uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 #v2
      with:
        client-id: ${{ vars.ARM_CLIENT_ID }}
        tenant-id: ${{ vars.ARM_TENANT_ID }}
        allow-no-subscriptions: true
    - name: Populate kubeconfig with k6 context
      id: populate_kubeconfig_with_k6_context
      shell: bash
      run: |
        if ! az aks install-cli; then
          echo "Failed to install kubectl CLI"
          exit 1
        fi

        if ! az aks get-credentials --resource-group k6tests-rg --name k6tests-cluster; then
          echo "Failed to populate kubeconfig"
          exit 1
        fi

        if ! kubelogin convert-kubeconfig -l azurecli; then
          echo "Failed to convert kubeconfig"
          exit 1
        fi
    - name: Setup k6
      uses: grafana/setup-k6-action@6e12d9dc873f3ade01a7d9bdddd0805b50b4cf50
    - name: Run K6 tests (${{ inputs.testSuitePath }})
      shell: bash
      run: |
        echo "Running k6 test suite ${{ inputs.testSuitePath }} with ${{ inputs.vus }} VUs for ${{ inputs.duration }} on ${{ inputs.parallelism }} parallelism"
        k6configName=$(basename "${{ inputs.testSuitePath }}" .js)
        k6configName="k6-${k6configName}"
        ./src/apps/Altinn.Authorization/test/K6/performance/run-test-in-k8s.sh \
          -f "${{ inputs.testSuitePath }}" \
          -c "$k6configName" \
          -n "$k6configName" \
          -v "${{ inputs.vus }}" \
          -d "${{ inputs.duration }}" \
          -p "${{ inputs.parallelism }}" \
          -a "${{ inputs.abortOnFail }}" \
          -b "${{ inputs.breakpoint }}"
      env:
        API_ENVIRONMENT: ${{ inputs.environment }}
        API_VERSION: ${{ inputs.apiVersion }}