meta {
  name: GET_EUS_AuthorizedParties_Dagl_Regn_IncludePartiesViaKeyRolesAuto
  type: http
  seq: 12
}

get {
  url: {{baseUrl}}/accessmanagement/api/v1/enduser/authorizedparties?includePartiesViaKeyRoles=auto
  body: json
  auth: inherit
}

params:query {
  includePartiesViaKeyRoles: auto
}

headers {
  Content-Type: application/json
  Accept: application/json
}

script:pre-request {
  
  const sharedtestdata = require(`./testdata/sharedtestdata.js`);
  const testdata = require(`./test/AuthorizedParties/testdata/${bru.getEnvVar("tokenEnv")}.js`);
  
  bru.setVar("requestName", "GET_EUS_AuthorizedParties_Dagl_Regn_IncludePartiesViaKeyRolesAuto");
  
  var getTokenParameters = {
    auth_userId: testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.dagligleder.userId,
    auth_partyId: testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.dagligleder.partyId,
    auth_partyUuid: testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.dagligleder.partyUuid,
    auth_ssn: testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.dagligleder.pid,
    auth_tokenType: sharedtestdata.authTokenType.personal,
    auth_scopes: sharedtestdata.auth_scopes.authorizedParties
  }
  
  
  const testTokenGenerator = require(`./TestToolsTokenGenerator.js`);
  const token = await testTokenGenerator.getToken(getTokenParameters);
  bru.setVar("bearerToken", token);
}

tests {
  const sharedtestdata = require(`./testdata/sharedtestdata.js`);
  const testdata = require(`./test/AuthorizedParties/testdata/${bru.getEnvVar("tokenEnv")}.js`);
  const body = res.getBody().data;
  const requestName = bru.getVar("requestName");
  
  test(requestName + "|HttpStatus.OK", function() {
    expect(res.status).to.equal(200);
  });
  
  test(requestName + "|Inheirits all mainunit accesses on subunits", function() {  
    // Test that all authorized rights on main units also exists on all subunits
    body.forEach((party, partyIndex) => {
      if (party.subunits && party.subunits.length > 0) {
        party.subunits.forEach((subunit, subunitIndex) => {
          try {
            assert.includeMembers(
              subunit.authorizedAccessPackages,
              party.authorizedAccessPackages,
              `Subunit ${subunitIndex} of party ${partyIndex} does not include all authorizedAccessPackages`
            );
  
            assert.includeMembers(
              subunit.authorizedResources,
              party.authorizedResources,
              `Subunit ${subunitIndex} of party ${partyIndex} does not include all authorizedResources`
            );
  
            assert.includeMembers(
              subunit.authorizedRoles,
              party.authorizedRoles,
              `Subunit ${subunitIndex} of party ${partyIndex} does not include all authorizedRoles`
            );
          } catch (error) {
            console.error(error.message);
            throw error; // Re-throw to make sure Bruno registers the test as failed
          }
        });
      }
    });
    
  });
  
  test(requestName + "|Mainunit AuthorizedInstances not inherited to subunits", function() {  
    // Test that any authorized instances on main units does not exist on any subunits
    body.forEach((party, partyIndex) => {
      const parentInstances = party.authorizedInstances || [];
  
      if (party.subunits && party.subunits.length > 0 && parentInstances.length > 0) {
        party.subunits.forEach((subunit, subunitIndex) => {
          const subunitInstances = subunit.authorizedInstances || [];
  
          const overlappingInstances = parentInstances.filter(instance =>
            subunitInstances.includes(instance)
          );
  
          try {
            assert.strictEqual(
              overlappingInstances.length,
              0,
              `Subunit ${subunitIndex} of party ${partyIndex} contains one or more parent authorizedInstances: ${overlappingInstances.join(', ')}`
            );
          } catch (error) {
            console.error(error.message);
            throw error;
          }
        });
      }
    });
  
  });
  
  test(requestName + "|Check for duplicate parties in the response", function() {  
    // Step 1: Collect all partyUuids
    const allPartyUuids = [];
  
    body.forEach(party => {
      allPartyUuids.push(party.partyUuid);
      if (party.subunits && party.subunits.length > 0) {
        party.subunits.forEach(subunit => {
          allPartyUuids.push(subunit.partyUuid);
        });
      }
    });
  
    // Step 2: Find duplicates
    const uuidCount = {};
    const duplicates = [];
  
    allPartyUuids.forEach(uuid => {
      uuidCount[uuid] = (uuidCount[uuid] || 0) + 1;
      if (uuidCount[uuid] === 2) {
        duplicates.push(uuid); // only push once when it becomes a duplicate
      }
    });
  
    // Step 3: Assert no duplicates
    expect(duplicates.length, `Duplicate partyUuid(s) found: ${duplicates.join(', ')}`).to.equal(0);
  
  });
  
  test(requestName + "|Find expected Client AuthorizedParty and AuthorizedAccessPackages", function() {  
    // Test that the expected client party exists in the response with the expected packages
    
    const allParties = body.flatMap(party => [party, ...(party.subunits || [])]);
    const targetParty = allParties.find(party => party.partyUuid === testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_USENSUELL_UVIRKSOM_TIGER.partyUuid);
  
    assert.exists(targetParty, 'Expected ClientParty: '+testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_USENSUELL_UVIRKSOM_TIGER.name+' to exist');
    assert.includeMembers(targetParty.authorizedAccessPackages, ["regnskapsforer-lonn", "regnskapsforer-med-signeringsrettighet", "regnskapsforer-uten-signeringsrettighet"]);
    expect(targetParty.authorizedAccessPackages.length, `authorizedAccessPackages for Client contains unexpected packages`).to.equal(3);
    
  });
  
  test(requestName + "|Find expected Innehaver of ENK Client AuthorizedParty and AuthorizedAccessPackages", function() {  
    // Test that the expected client party exists in the response with the expected packages
    
    const allParties = body.flatMap(party => [party, ...(party.subunits || [])]);
    const innehaverOfActiveEnk = allParties.find(party => party.partyUuid === testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_ENK_HUMAN_TOPP_KATT_BIL.innehaver.partyUuid);
    const innehaverOfDeletedEnkLessThanTwoYears = allParties.find(party => party.partyUuid === testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_ENK_DELETED_2025_11_27_InnehaverAccess.innehaver.partyUuid);
    const innehaverOfDeletedEnkMoreThanTwoYears = allParties.find(party => party.partyUuid === testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_ENK_DELETED_2023_11_01_NoInnehaverAccess.innehaver.partyUuid);
  
    assert.exists(innehaverOfActiveEnk, 'Expected Innehaver of Enk-ClientParty: '+testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_ENK_HUMAN_TOPP_KATT_BIL.innehaver.name+' to exist');
    assert.includeMembers(innehaverOfActiveEnk.authorizedAccessPackages, ["regnskapsforer-lonn", "regnskapsforer-med-signeringsrettighet", "regnskapsforer-uten-signeringsrettighet"]);
    expect(innehaverOfActiveEnk.authorizedAccessPackages.length, `authorizedAccessPackages for Client contains unexpected packages`).to.equal(3);
    
    assert.exists(innehaverOfDeletedEnkLessThanTwoYears, 'Expected Innehaver of Enk-ClientParty: '+testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_ENK_DELETED_2025_11_27_InnehaverAccess.innehaver.name+' to exist');
    assert.includeMembers(innehaverOfDeletedEnkLessThanTwoYears.authorizedAccessPackages, ["regnskapsforer-lonn", "regnskapsforer-med-signeringsrettighet", "regnskapsforer-uten-signeringsrettighet"]);
    expect(innehaverOfDeletedEnkLessThanTwoYears.authorizedAccessPackages.length, `authorizedAccessPackages for Client contains unexpected packages`).to.equal(3);
    
    assert.strictEqual(innehaverOfDeletedEnkMoreThanTwoYears, undefined, 'Expected Innehaver of Enk-ClientParty: '+testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.client_ENK_DELETED_2023_11_01_NoInnehaverAccess.innehaver.name+' to NOT exist');
    
  });
  
  test(requestName + "|Find expected KeyRole AuthorizedParty and AuthorizedAccessPackages", function() {
    const allParties = body.flatMap(party => [party, ...(party.subunits || [])]);
    const targetParty = allParties.find(party => party.partyUuid === testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.partyUuid);
  
    assert.exists(targetParty, 'Expected KeyRole-party: '+testdata.REGN_ULASTELIG_RETTFERDIG_TIGER.name+' to exist');
    assert.notIncludeMembers(targetParty.authorizedAccessPackages, ["eksplisitt", "maskinporten-scopes-nuf", "post-til-virksomheten-med-taushetsbelagt-innhold"]);
    expect(targetParty.authorizedAccessPackages.length, `authorizedAccessPackages for Dagl-KeyRole-Party contains unexpected packages`).to.equal(sharedtestdata.expectedDaglAccessPackageCount);
    
  });
  
  
}
